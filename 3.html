<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>select</title>
    <!--#include file="/common/head.html"-->
    <style type="text/css">
        .set-enum{
            display: none;
        }
        .add-select-num{
            /* background: #FC8A15; */
            /* font-weight: bold; */
            font-size: 20px;
            /* padding: 5px; */
            /* border-radius: 29px; */
            color: #FC8A15;
            cursor: pointer;
        }
        .enum-set-tab{
            display: inline-block;
            /*!*border: 2px darkgray solid;*!*/
            /*padding: 5px;*/
            /*background: #4f8edc;*/
            /*color: #fff;*/
            /*margin-left: 5px;*/
            /*margin-top: 3px;*/
            padding: 8px 5px 8px 10px;
            /*max-height: 30px;*/
            margin: 2px;
            position: relative;
            line-height: 13px;
            color: #333;
            cursor: default;
            border: 1px solid #FC8A15;
            background-clip: padding-box;

        }
        .J_delEnumBtn{
            padding-left: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        .J_delEnumBtn:hover{
            color: #FC8A15;
        }
        .tip{
            color: red;
        }
    </style>
</head>
<body>
<div style="padding: 100px;margin: 0 auto;">
    <div class="J_ruleCheck">
        枚举值： <input type="text" name="" class="J_enumDetail" value="id, name, val_id">
        <input type="checkbox" name="" value="" class="J_setEnum" >设置枚举值
        <div class="J_displayEnumOper set-enum" >
            <select class="J_selectEnum"></select>
            <select class="J_stripsOper">
                <option data-oper="gt" value=">"> >  </option>
                <option data-oper="lt" value="<"> <  </option>
                <option data-oper="ge" value=">="> >= </option>
                <option data-oper="le" value="<="> <= </option>
                <option data-oper="eq" value="="> =  </option>
            </select>
            <input type="text" class="J_enumStrips" value="" placeholder="条数">
            <input type="hidden" class="J_saveScaleOper" value="">
            <select class="J_scaleOper">
                <option data-oper="gt" value=">"> >  </option>
                <option data-oper="lt" value="<"> <  </option>
                <option data-oper="ge" value=">="> >= </option>
                <option data-oper="le" value="<="> <= </option>
                <option data-oper="eq" value="="> =  </option>
            </select>
            <input type="text" class="J_enumScale" value="" placeholder="占比">%
            <span class="J_addEnum add-select-num fa fa-plus-circle"></span>
            <ul class="J_enumSetContainer" style="border: 1px solid blue; width: 500px; height: 300px;padding: 10px;">
                <!--模板渲染-->
                <li class="enum-set-tab" data-save-enum="id" data-save-strips-oper="gt" data-save-strips="10" data-save-scale-oper="eq" data-save-scale="20">
                    <!--符号需根据情况渲染-->
                    <span class="J_enumValue">id：>10，=20</span>
                    <span class="J_delEnumBtn fa fa-times"></span>
                </li>
            </ul>
        </div>
    </div>
    <button type="button" class="J_submit">提交</button>
    <div class="J_ruleCheck">
        枚举值： <input type="text" name="" class="J_enumDetail" value="id, name, val_id">
        <input type="checkbox" name="" value="" class="J_setEnum" >设置枚举值
        <div class="J_displayEnumOper set-enum" >
            <select class="select-style len-300 J_selectEnum"></select>
            <select class="select-style J_stripsOper">
                <option data-oper="gt" value=">"> >  </option>
                <option data-oper="lt" value="<"> <  </option>
                <option data-oper="ge" value=">="> >= </option>
                <option data-oper="le" value="<="> <= </option>
                <option data-oper="eq" value="="> =  </option>
            </select>
            <input type="text" class="J_enumStrips" value="" placeholder="条数">
            <select class="select-style J_scaleOper">
                <option data-oper="gt" value="gt"> >  </option>`
                <option data-oper="lt" value="<"> <  </option>
                <option data-oper="ge" value=">="> >= </option>
                <option data-oper="le" value="<="> <= </option>
                <option data-oper="eq" value="="> =  </option>
            </select>
            <input type="text" class="J_enumScale" value="" placeholder="占比">%
            <span class="J_addEnum add-select-num fa fa-plus-circle"></span>
            <ul class="J_enumSetContainer" style="border: 1px solid blue; width: 500px; height: 300px;padding: 10px;">
                <!--模板渲染-->
                <li class="enum-set-tab" data-save-enum="id">
                    <span class="J_enumValue">id：10，0.2</span>
                    <!--渲染已设置的枚举值字段-->
                    <!--<input type="hidden" value="id" class="J_saveEnumSet">-->
                    <span class="J_delEnumBtn fa fa-times"></span>
                </li>
            </ul>
        </div>
    </div>
    <button type="button" class="J_submit">提交</button>
</div>
</body>
<script>
    $(document).ready(function(){
        function setEnum() {
            var
                enumDetailValue = $.trim($(".J_enumDetail").val()),
                enumArr,
                initialOption,
                optionStr = '',
                str;

            if(enumDetailValue != ''){
                enumArr = enumDetailValue.split(/[，,]/);
                if($('.J_selectEnum').find('option').length > 0){
                    $('.J_selectEnum').empty();
                }
                $(enumArr).each(function (item, value) {
                    optionStr += '<option value = "'+ $.trim(value) +'">'+ $.trim(value) +'</option>';
                });
                initialOption = '<option value="0">请选择</option>';
                str = initialOption + optionStr;
                $('.J_selectEnum').append(str);
            }
        }

        $(document).on('change','.J_setEnum' ,function (e) {
            var containerEl = $(e.target).parents('.J_ruleCheck');

            if ($('.J_setEnum',containerEl).is(':checked') == true){
                $('.J_displayEnumOper',containerEl).removeClass('set-enum');
                setEnum();
            }else{
                $('.J_displayEnumOper',containerEl).addClass('set-enum');
            }
        });
        $(document).on('blur', '.J_enumDetail', function () {
            setEnum();
        });
        $(document).on('click','.J_addEnum' ,function (e) {
            var
                container = $(e.target).parents('.J_ruleCheck'),  //
                selectEnumValue = $('.J_selectEnum', container).val(),
                stripOper = $('.J_stripsOper', container).val(),
                enumStripsVaule = $('.J_enumStrips',container).val(),
                scaleOper = $('.J_scaleOper', container).val(),
                enumScaleValue = $('.J_enumScale',container).val(),
                setEnumTab,
                setEnumValue,
                isRepeat,
                enumSetArr,
                tipSpan,
                enumSetTabEls;

            enumSetTabEls =  $(e.target).next('.J_enumSetContainer').children('.enum-set-tab');
            // TODO:get-array
            enumSetArr = $(enumSetTabEls).map(function(){ return $(this).attr('data-save-enum');}).get();   //array

            for(var i=0;i < enumSetArr.length;i++){
               if (enumSetArr[i] == selectEnumValue){
                   isRepeat = true;
               }
            }
            if( isRepeat == true ){
                tipSpan = '<span class = "tip">您已设置过该枚举值!</span>';
                $('.J_enumSetContainer', container).append(tipSpan);
                setTimeout(function(){$('.tip', container).remove();},1000);
            }else{
                if(selectEnumValue == '0'){
                    $('.J_selectEnum').focus();
                }else{
                    if(enumScaleValue == ''){
                        enumScaleValue = 0;
                    }
                    if(enumStripsVaule == ''){
                        enumStripsVaule = 0;
                    }

                    setEnumValue = selectEnumValue + "："+ stripOper + enumStripsVaule +"，"+ scaleOper + enumScaleValue;
                    setEnumTab = '<li class="enum-set-tab" data-save-enum="'+ selectEnumValue +'" data-save-strips-oper="'+ stripOper +'" data-save-strips="'+ enumStripsVaule +'" data-save-scale-oper="'+ scaleOper +'" data-save-scale="'+ enumScaleValue +'"><span class="J_enumValue">'+
                            setEnumValue + '</span><span class="J_delEnumBtn fa fa-times"></span></li>';
                    $('.J_enumSetContainer').append(setEnumTab);
                }
            }
        });
        $(document).on('click','.J_delEnumBtn', function (e) {
            $(e.target).parents('.enum-set-tab').remove();
        });
        $(document).on('click', '.J_submit', function (e) {
            //取select
            var
                containerEl = $(e.target).prev('.J_ruleCheck'),
                liEls = $('.J_enumSetContainer', containerEl ).children('li'),
                //option
                optionEl = $('.J_selectEnum', containerEl).children('option'),
                optionLength = optionEl.length,
                //存放下拉列表数据的数组
                enumValue,
                selectArr = [],
                stripsObj = {},
                scaleObj = {},
                enumObj = {},
                post_data = {};


            for(var i = 1; i < optionLength; i++){
                selectArr.push(optionEl[i].text);
            }
            $(liEls).each(function (index, item) {
                enumValue = $(item).attr('data-save-enum');
                for(var i = 0; i < selectArr.length; i++) {
                    if (selectArr[i] == enumValue) {
                        console.log("在：" + selectArr[i]);
                        console.log(enumValue);
                        stripsObj["num"] = $(item).attr('data-save-strips');
                        stripsObj["symbol"] = $(item).attr('data-save-strips-oper');
                        scaleObj["num"] = $(item).attr('data-save-scale');
                        scaleObj["symbol"] = $(item).attr('data-save-scale-oper');
                        selectArr.splice(i, 1);  //减少循环
                        enumObj[enumValue] = JSON.parse('{'+'"strips":' + JSON.stringify(stripsObj) + ',' + '"scale":' + JSON.stringify(scaleObj) + '}');
        //              enumObj[enumValue] = '{'+'"strips":' + JSON.stringify(stripsObj) + ',' + '"scale":' + JSON.stringify(scaleObj) + '}';
                        post_data["enum_detail"] = enumObj;
                    }
                }
                //对未设置枚举的字段设定默认值
                for(var s = 0; s < selectArr.length; s++){
                    enumValue = selectArr[s];
                    stripsObj["num"] = 0;
                    stripsObj["symbol"] = "";
                    scaleObj["num"] = 0;
                    scaleObj["symbol"] = "";
                    enumObj[enumValue] = JSON.parse('{'+'"strips":' + JSON.stringify(stripsObj) + ',' + '"scale":' + JSON.stringify(scaleObj) + '}');
//                  enumObj[enumValue] = '{'+'"strips":' + JSON.stringify(stripsObj) + ',' + '"scale":' + JSON.stringify(scaleObj) + '}';
                    post_data["enum_detail"] = enumObj;
                }
                console.log(post_data);
            });






//            for(var r = 0; r < selectArr.length; r++){
//                for(var t = 0; t < tabArr.length; t++){
//                    if(selectArr[r] == tabArr[t]){
//                        console.log("zai:"+selectArr[r]);
//                    }else{
//                        console.log("buzai:"+selectArr[r]);
//                    }
//                }
////            }
//            for(var t = 0; t < tabArr.length; t++){
//                if(selectArr.contains(tabArr[t])){
//                    console.log(tabArr[t]);
//                }
//            }

        });
//        Array.prototype.contains = function (obj) {
//            var i = this.length;
//            while (i--) {
//                if (this[i] === obj) {
//                    return true;
//                }
//            }
//            return false;
//        }

    })
    $(document).on('click','.J_scaleOper', function (e) {
        console.log($(e.target).val());
        $(e.target).prev('.J_saveScaleOper').val($(e.target).val());

    });
</script>
</html>